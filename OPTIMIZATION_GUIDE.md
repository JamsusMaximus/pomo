# Build & Deployment Optimization Guide

## Overview

This project has been optimized for maximum developer productivity and CI/CD speed using Turborepo for intelligent caching and streamlined git hooks.

## What Changed

### Git Hooks

**Pre-commit** (5-10 seconds)

- ‚úÖ Auto-format with Prettier
- ‚ùå Removed ESLint (runs in CI)
- ‚ùå Removed doc checks (runs in CI)

**Pre-push** (10-30 seconds)

- ‚úÖ TypeScript type checking
- ‚úÖ Unit tests (only if test files changed)
- ‚ùå Removed full build (runs in CI)
- ‚ùå Removed route tests (runs in CI)

### Build System

**Turborepo Integration**

- Intelligent caching based on file inputs
- Skips tasks when nothing changed
- Shared cache across local and CI

**Scripts Updated**

```bash
# These now use Turbo caching:
npm run build        # Next.js build
npm run typecheck    # TypeScript
npm run lint         # ESLint
npm run lint:strict  # ESLint strict mode
npm run format:check # Prettier check
npm test             # Vitest
npm run test:e2e     # Playwright (cache disabled)
```

### CI/CD Pipeline

**4 Parallel Jobs:**

1. **Lint & Format** - Prettier + ESLint
2. **TypeCheck & Tests** - TypeScript + Vitest
3. **Build** - Next.js build (runs after 1 & 2)
4. **E2E Tests** - Playwright (runs after 3)

**Optimizations:**

- Turborepo cache shared across jobs
- Build artifacts passed between jobs
- Playwright browsers cached
- No `--with-deps` flag (faster install)

## Performance Comparison

| Task                 | Before   | After   | Improvement |
| -------------------- | -------- | ------- | ----------- |
| Pre-commit           | 30-60s   | 5-10s   | **80-85%**  |
| Pre-push             | 5-15min  | 10-30s  | **95-98%**  |
| Local build (cached) | 2-5min   | 10-30s  | **75-90%**  |
| CI pipeline          | 10-15min | 8-12min | **20-30%**  |

## How Turbo Caching Works

### Local Development

```bash
# First run - no cache
npm run build  # Takes 2-3 minutes

# Second run - cached
npm run build  # Takes ~5 seconds (cache hit)

# After changing a file
npm run build  # Rebuilds only what's needed
```

### Cache Invalidation

Turbo automatically invalidates cache when:

- Source files change (defined in `turbo.json` inputs)
- Dependencies change (package.json/package-lock.json)
- Environment variables change (defined in `turbo.json` env)

### Viewing Cache Stats

```bash
# See what's cached
npx turbo run build --dry-run

# Force rebuild without cache
npx turbo run build --force
```

## Developer Workflow

### Making a Commit

```bash
git add .
git commit -m "feat: new feature"
# ‚ú® Auto-formats in ~5 seconds
```

### Pushing Changes

```bash
git push
# üîé TypeScript check in ~10-30 seconds
# ‚úÖ Push succeeds
# üöÄ Full CI runs on GitHub
```

### Bypassing Hooks

```bash
# Skip pre-commit
git commit --no-verify

# Skip pre-push
git push --no-verify
```

## CI Workflow Details

### Job: Lint & Format (1-2 min)

- Prettier format check
- ESLint with strict mode
- Runs in parallel with tests

### Job: TypeCheck & Tests (1-2 min)

- TypeScript type checking
- Vitest unit tests
- Runs in parallel with lint

### Job: Build (2-4 min)

- Needs: Lint + Tests to pass
- Runs Next.js production build
- Uploads `.next/` artifacts

### Job: E2E Tests (3-5 min)

- Needs: Build to complete
- Downloads build artifacts (no rebuild!)
- Runs Playwright tests
- Only installs chromium browser

## Turbo Configuration

### turbo.json Structure

```json
{
  "tasks": {
    "build": {
      "inputs": ["app/**", "components/**", ...],
      "outputs": [".next/**"],
      "env": ["NEXT_PUBLIC_*", ...]
    }
  }
}
```

**Key concepts:**

- `inputs`: Files that affect this task
- `outputs`: Files generated by this task
- `env`: Environment variables that affect output
- `dependsOn`: Tasks that must run first
- `cache`: Whether to cache this task

### Adding New Tasks

1. Add script to `package.json`:

```json
"my-task": "some-command"
```

2. Add task config to `turbo.json`:

```json
"my-task": {
  "inputs": ["relevant/**/*.ts"],
  "outputs": ["dist/**"],
  "cache": true
}
```

3. Run with caching:

```bash
npx turbo run my-task
```

## Troubleshooting

### Cache Issues

**Clear local cache:**

```bash
rm -rf .turbo
```

**Clear CI cache:**

- Go to Actions ‚Üí Caches
- Delete `turbo-*` caches

### Build Not Cached

Check if inputs changed:

```bash
npx turbo run build --dry-run
# Shows: "cache miss" and why
```

Common causes:

- Environment variables changed
- Git ignored files changed
- Clock skew (rare)

### Pre-push Hook Slow

If typecheck is slow:

```bash
# Check for type errors
npm run typecheck

# Skip hook temporarily
git push --no-verify
```

### Playwright Install Fails

Install browsers manually:

```bash
npx playwright install chromium
```

## Advanced: Remote Caching

To share cache across team (optional):

### Option 1: Vercel Remote Cache

```bash
npx turbo login
npx turbo link
```

### Option 2: Custom Remote Cache

Update `turbo.json`:

```json
{
  "remoteCache": {
    "signature": true
  }
}
```

Set environment variable:

```bash
export TURBO_TOKEN="your-token"
export TURBO_TEAM="your-team"
```

## Best Practices

### Do's

- ‚úÖ Commit often with small changes
- ‚úÖ Run `npm run typecheck` before pushing
- ‚úÖ Let CI run full builds and tests
- ‚úÖ Trust Turbo cache (it's smart)
- ‚úÖ Add new file patterns to `turbo.json` inputs

### Don'ts

- ‚ùå Don't bypass hooks by default
- ‚ùå Don't manually delete `.turbo` cache (unless debugging)
- ‚ùå Don't add heavy tasks to pre-commit
- ‚ùå Don't commit `.turbo` directory

## Monitoring

### GitHub Actions

- View parallel job execution
- Check cache hit rates in logs
- Monitor build times

### Local Metrics

```bash
# Verbose output
npx turbo run build --verbosity=2

# Timing information
time npm run build
```

## Future Optimizations

Potential next steps:

1. **pnpm** - 30-50% faster installs
2. **Remote caching** - Share across team
3. **Nx** - More advanced monorepo features
4. **Build splitting** - Incremental page builds
5. **Docker layer caching** - For container builds

## Support

Having issues? Check:

1. This guide's troubleshooting section
2. [Turborepo docs](https://turbo.build/repo/docs)
3. Project's GitHub issues

---

**Last updated:** 2025-10-17
**Turbo version:** 2.5.8
**Node version:** 20.x
